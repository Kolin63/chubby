#!/usr/bin/env bash

function print_help() {
  echo "usage: chubby [-t timer] [-O legacy_scp] [-r recursive]"
  echo "              [-B batch_mode] [-p port] [-D pre_delete] src dest"
}

if [ $# -lt 2 ]; then
  print_help
  exit 0
fi

timer=0
legacy=""
recursive=""
batch=""
port=22
predelete=0

src="${@: -2:1}"
dest="${@: -1}"

for (( i=1; i<=$#; i++ ));  do
  arg=${@: $i:1}
  if [[ "$arg" == "-t" ]]; then
    timer=${@: $(($i+1)):1}
  elif [[ "$arg" == "-O" ]]; then
    legacy="-O"
  elif [[ "$arg" == "-r" ]]; then
    recursive="-r"
  elif [[ "$arg" == "-B" ]]; then
    batch="-B"
  elif [[ "$arg" == "-p" ]] || [[ "$arg" == "-P" ]]; then
    port=${@: $(($i+1)):1}
  elif [[ "$arg" == "-D" ]]; then
    predelete=1
  fi
done

# params: value, name
function check_int() {
  if [[ $1 =~ ^[0-9.]+$ ]]; then
    return
  else
    echo chubby: bad $2 \"$1\"
    print_help
    exit 1
  fi
}

check_int $timer timer
check_int $port port

if [ $predelete -eq 1 ] && [ $recursive == "-r" ]; then
  echo "WARNING: PreDelete and Recursive are enabled, which is potentially"
  echo "         destructive. This means that all folders and directories will"
  echo "         be deleted before the copy is made. Before continuing, double"
  echo "         check that the destination path is correct to avoid losing"
  echo "         data.

  while [[ "$answer" != "Y" ]] && [[ "$answer" != "y" ]]; do
    read -p "Continue and risk losing data? (y/N): " answer
    if [[ "$answer" == "n" ]] || [[ "$answer" == "N" ]] || [[ "$answer" == "" ]]; then
      exit 0
    fi
  done
  echo
fi

echo Timer: $timer
echo Port: $port
echo Source: $src
echo Destination: $dest
echo
echo Starting Chubby

while true; do

  if [ $predelete -eq 1 ]; then
    if [[ "$dest" == *:* ]]; then
      host="${dest%%:*}"
      path="${dest#*:}"
      ssh $host -p $port rm $path $recursive
    else
      rm $dest $recursive
    fi
  fi

  command="scp -P $port $legacy $recursive $batch $src $dest"
  $command > /dev/null
  if [ $? -eq 0 ]; then
    echo $(date +%T): Update Complete

  elif [ "$legacy" == "" ]; then
    echo
    echo Enabling legacy scp to attempt to resolve the issue
    while [[ "$answer" != "Y" ]] && [[ "$answer" != "y" ]]; do
      read -p "Continue and enable legacy scp? (Y/n): " answer
      if [[ "$answer" == "n" ]] || [[ "$answer" == "N" ]]; then
        exit 0
      elif [[ "$answer" == "" ]]; then
        break
      fi
    done
    legacy="-O"
    echo
  else
    exit $?
  fi

  if [ $timer -gt 0 ]; then
    sleep $timer
  else
    while [[ "$answer" != "Y" ]] && [[ "$answer" != "y" ]]; do
      read -p "Continue? (Y/n): " answer
      if [[ "$answer" == "n" ]] || [[ "$answer" == "N" ]]; then
        exit 0
      elif [[ "$answer" == "" ]]; then
        break
      fi
    done
  fi
done
